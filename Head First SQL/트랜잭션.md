# 트랜잭션

- 트랜잭션은 한 단위의 일을 수행하는 일련의 SQL 문이며 쿼리의 집합이다.
- ::트랜잭션동안 모든 단계가 방행없이 완료될 수 없다면 어떤것도 완료되지 말아야한다.

## 문제

### EXAMPLE 1

- 계좌 A가 있고 계좌 B가 있다고 하자, A계좌는 1000만원 B계좌는 100만원이있다.
- 계좌 A에서 계좌 B로 1000만원을 이체를 하는 도중에 정전이 되거나 어떠한 문제가 발생한다면 1000만원은 데이터 상에 사라지는 위험이 있다.

### EXAMPLE 2

- 친구 A와 B가 사용하는 공동계좌가 있다고하자 행당 계좌는 500만원이 있다.
- 친구 A는 500만원을 출금하려고하고 B는 400만원을 출금하려고 동시에 접근을한다면 A가 500만원을 출금하고 B는 출금이 되면 안되지만 동시 접근 때문에 B도 출금이되면서 900만원이 손해를 보게된다.

## ACID

### ATOMICITY(원자성)

- 트랜잭션을 구성하는 모든 명령이 실행되거나 어떠한 명령도 실행되지 않아야한다.
- 트랜잭션의 일부만을 수행할 수 없다.
- 예제 1번에서 1000만원에 돈이 사라진거는 트랜잭션의 일부만이 수행되었기 때문이다.

### CONSISTENCY(일관성)

- 트랜잭션이 끝난 후 데이터베이스는 일관성을 유지해야한다.
- 예제 2번 같은 경우가 일관성이 없는 것이다.

### ISOLATION(독립성)

- 독립성이란 모든 트랜잭션은 동시에 일어나는 트랜잭션과 상관없이 데이터베이스에 일관된 뷰를 가지고있다.

### DURABILITY(지속성)

- 트랜잭션이 끝난 후 데이터베이스는 데이터를 정확히 저장하고 정전이나 그 외의 이상 상항으로부터 데이터를 보호해야한다.
- 보통은 트랜잭션의 기록을 주 데이터베이스외에 다른 위치의 데이터베이스에 저장하는 방식을 사용한다.
- 예제 1번에서 트랜잭션이 다른 곳에 보관되어있다면 돈을 찾을 수 있다.

## 명령어

### 트랜잭션 시작

```sql
START TRANSACTION;
```

- COMMIT 이나 ROLLACK 나올 때 까지 SQL을 추적한다.

### 데이터 반영

```sql
COMMIT;
```

- 모든 명령이 제 위치에 있고 문제가 없는거 같으면 COMMIT이라고 입력하면 트랜잭션의 내용을 영속적으로 만든다.

### 원점 복구

```sql
ROLLBACK;
```

- 뭔가 문제가 있으면 ROLLBACK을 사용하여 모든것을 START TRANSACTION을 입력하기 전 상황으로 되돌린다.
- ::COMMIT 하기 전에는 데이터베이스에 어떠한 변화도 발생하지 않는다.
- ::트랜잭션을 시작했다면 COMMIT 또는 ROLLBACK을 해줘야한다, 트랜잭션 중에 수행된 모든 내용을 보관하고 있으며 이거를 "트랜잭션 로그"라고하고 많은 일을 할수록 로그가 커지며 공간 + 자원 낭비가 된다.

## MYSQL + 트랜잭션

- MYSQL로 트랜잭션을 수행하려면 올바른 저장엔진을 사용해야한다.
- 저장엔진의 타입별로 트랜잭션을 허용하기도 하고 그렇지않기도 한다.
- ::저장엔진은 데이터베이스의 모든 데이터와 구조를 저장하는 하부구조이다.
- ::저장엔진이 트랜잭션을 지원하는 BOB이거나 InnoDB인지 확인이 필요하다.

### 엔진변경

```sql
ALTER TABLE "테이블 이름" TYPE = InnoDB;
```

- example

```sql
START TRANSACTION;
"~SQL 내용"
COMMIT OR ROLLBACK;
```
